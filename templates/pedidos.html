{% extends "base.html" %}

{% block title %}Listado de Pedidos{% endblock %}
{% block header %}ðŸ“¦ Historial de Pedidos{% endblock %}

{% block content %}
<div class="container py-3">

    <!-- Barra de filtros -->
    <form class="row g-2 mb-3" method="GET" action="{{ url_for('ver_pedidos') }}">
    <div class="col-6 col-md-2">
      <input type="text" name="numero_pedido" class="form-control form-control-sm"
             placeholder="ðŸ”¢ Pedido" value="{{ request.args.get('numero_pedido','') }}">
    </div>
    <div class="col-6 col-md-2">
        <select name="estado" class="form-select form-select-sm">
        <option value="">ðŸ“Œ Cualquier estado</option>
        {% for s in status_pedidos %}
            <option value="{{ s.id }}" {% if estado_seleccionado == s.id|string %}selected{% endif %}>{{ s.nombre }}</option>
        {% endfor %}
        </select>
    </div>

    <div class="col-6 col-md-2 d-flex gap-1">
        <button class="btn btn-primary btn-sm flex-fill" type="submit">
        <i class="bi bi-funnel-fill me-1"></i> Filtrar
        </button>
        <a href="{{ url_for('ver_pedidos') }}" class="btn btn-outline-secondary btn-sm flex-fill">
        <i class="bi bi-x-circle me-1"></i> Limpiar
        </a>
    </div>
    </form>

    {% if pedidos %}
        {% for pedido in pedidos %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><strong>Pedido #{{ pedido.numero_pedido }}</strong></span>
                <span>{{ pedido.fecha.strftime('%d-%m-%Y %H:%M') }}</span>
            </div>

            <div class="card-body">
                <p><strong>Cliente:</strong> {{ pedido.cliente or "Sin especificar" }}</p>
                <p><strong>Cantidad Total:</strong> {{ pedido.detalles | sum(attribute='cantidad') }}</p>
                <p><strong>Costo Total: $</strong>{{ pedido.costo_total }}</p>
                <p><strong>Observaciones:</strong> {{ pedido.observaciones or "N/A" }}</p>
                <p><strong>Estatus:</strong> {{ pedido.status_pedido or "N/A" }}</p>

                <hr>

                <h6 class="mb-3">Detalles del pedido</h6>

                {% if pedido.detalles %}
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Color</th>
                                    <th>Talla</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in pedido.detalles %}
                                <tr>
                                    <td>{{ d.color.nombre }}</td>
                                    <td>{{ d.talla.nombre }}</td>
                                    <td>{{ d.cantidad }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-warning mb-0">
                        Este pedido aÃºn no tiene detalles registrados.
                    </div>
                {% endif %}
            </div>

            <div class="card-footer text-muted d-flex justify-content-between align-items-center">
                <span>Registrado por: {{ pedido.usuario }}</span>

                {% if pedido.status_pedido != 5 and pedido.status_pedido != 6 %} 
                    <button class="btn btn-success btn-sm" onclick="marcarVendido({{ pedido.id }})">
                        âœ” Marcar como Vendido
                    </button>

                    <button class="btn btn-danger btn-sm" onclick="cancelarPedido({{ pedido.id }})">
                        âœ– Cancelar Pedido
                    </button>
                {% elif pedido.status_pedido == 5 %}
                    <span class="badge bg-success">VENDIDO</span>
                {% elif pedido.status_pedido == 6 %}
                    <span class="badge bg-danger">CANCELADO</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info text-center">
            No hay pedidos registrados aÃºn.
        </div>
    {% endif %}

</div>

<!-- ===========================
     ðŸ”¥ JAVASCRIPT 
=============================== -->
<script>
function marcarVendido(pedido_id) {

    if (!confirm("Â¿Confirmas que este pedido ya fue VENDIDO?")) {
        return;
    }

    fetch(`/pedido_vendido/${pedido_id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "ok") {
            alert("Pedido marcado como VENDIDO correctamente.");
            location.reload();
        } else {
            alert("Error: " + data.mensaje);
        }
    })
    .catch(err => {
        console.error("Error al marcar pedido:", err);
        alert("OcurriÃ³ un error al procesar la operaciÃ³n.");
    });
}
function confirmarVendido() {
    return confirm("Â¿Seguro que deseas marcar este pedido como VENDIDO?");
}

function cancelarPedido(pedido_id) {

    if (!confirm("Â¿Seguro que deseas CANCELAR este pedido?\n\nEsto regresarÃ¡ las piezas al inventario.")) {
        return;
    }

    fetch(`/pedido_cancelar/${pedido_id}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"}
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "ok") {
            alert("Pedido CANCELADO correctamente.");
            location.reload();
        } else {
            alert("Error: " + data.mensaje);
        }
    })
    .catch(err => {
        console.error("Error al cancelar pedido:", err);
        alert("OcurriÃ³ un error.");
    });
}

</script>

{% endblock %}