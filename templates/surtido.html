{% extends "base.html" %}
{% block title %}Salidas por Lote - Producci√≥n{% endblock %}
{% block header %}üõí Registro de Salida por Surtido{% endblock %}

{% block content %}
<style>
  .content {
    padding-bottom: 200px !important;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .resumen-vertical {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .resumen-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }
  .resumen-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    border-bottom: 2px solid #f8f9fa;
    padding-bottom: 0.75rem;
  }
  .color-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #0d6efd;
  }
  .table-wrapper {
    overflow-x: auto;
    max-height: calc(100vh - 500px);
    overflow-y: auto;
  }
  .resumen-table {
    margin-bottom: 0;
  }
  .resumen-table tbody tr {
    border-bottom: 1px solid #e9ecef;
  }
  .resumen-table tbody tr:last-child {
    border-bottom: 2px solid #dee2e6;
  }
  @media (max-width: 767px) {
    .content {
      padding-bottom: 220px !important;
    }
    .resumen-card {
      padding: 0.75rem;
    }
    .resumen-card-header {
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
    }
    .color-name {
      font-size: 1rem;
    }
    .table {
      font-size: 0.85rem;
    }
    .table th, .table td {
      padding: 0.5rem !important;
    }
    .btn-sm {
      font-size: 0.8rem;
      padding: 0.4rem 0.6rem;
    }
  }

  </style>

<div class="container mt-4">

  <!-- üß≠ Indicador de pasos -->
  <div class="d-flex justify-content-between mb-4">
    <span class="badge bg-primary fs-6">1Ô∏è‚É£ Datos</span>
    <span class="badge bg-secondary fs-6">2Ô∏è‚É£ Color</span>
    <span class="badge bg-secondary fs-6">3Ô∏è‚É£ Confirmar</span>
  </div>

  <!-- 1Ô∏è‚É£ Datos del Pedido -->
  <div class="card shadow-sm p-3 mb-4">
    <h5 class="fw-bold text-primary mb-3">Datos del PedidoüóíÔ∏è</h5>
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label fw-semibold">üî¢ Pedido</label>
        <input type="text" class="form-control" name="pedido" value="{{ultimo_pedido}}" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">üìÖFecha</label>
        <input type="date" class="form-control" name="fecha" value="{{ fecha_hoy }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">üë§Cliente</label>
        <input type="text" class="form-control" name="cliente" required>
      </div>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-5">
        <label class="form-label fw-semibold">Observaciones‚úèÔ∏è</label>
        <input type="text" class="form-control" name="observaciones">
      </div>
    </div>
  </div>

  <!-- 2Ô∏è‚É£ Selecci√≥n de color -->
  <div class="card shadow-sm p-3 mb-4">
    <h5 class="fw-bold text-primary mb-3">Selecciona el Color üé®</h5>
    <div class="d-flex align-items-center gap-2">
      <select class="form-select w-50" id="color">
        <option value="">-- Selecciona un color --</option>
        {% for c in colores %}
          <option value="{{ c.id }}">{{ c.nombre }}</option>
        {% endfor %}
      </select>
      <button type="button" class="btn btn-primary" id="btn_ver_inventario" disabled data-bs-toggle="modal" data-bs-target="#modalInventario" aria-label="Ver inventario del color seleccionado">
        <i class="bi bi-eye me-1"></i> Ver Inventario
      </button>
    </div>
  </div>

  <!-- Modal Inventario -->
  <div class="modal fade" id="modalInventario" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h4 class="fw-bold text-primary">Inventario del color:<span id="nombre_color_modal"></span> </h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="modal_body_inventario"></div>
          <div class="d-flex justify-content-between align-items-center mt-3">
            <h6>Inventario total disponible: <span id="modal_total_disponible" class="text-success fw-bold">0</span></h6>
            <h6>Total surtido: <span id="modal_total_surtido" class="text-primary fw-bold">0</span></h6>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" id="btn_agregar_modal">
            <i class="bi bi-plus-circle"></i> Agregar al lote
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 4Ô∏è‚É£ Resumen del Surtido -->
  <div class="mb-3 p-3 border rounded bg-light">
    <h5 class="fw-bold text-primary mb-3">Resumen del Surtido üìë</h5>
    
    <!-- Contenedor vertical del resumen -->
    <div class="resumen-vertical" id="contenedor_vertical"></div>

    <!-- Si no hay items agregados, mostrar mensaje -->
    <div id="sin-items-msg" class="alert alert-info text-center mt-3">
      No hay colores agregados a√∫n. Selecciona un color y agrega cantidades.
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
      <h6 class="fw-bold">Total general: <span id="total_general" class="text-primary">0</span></h6>

      <button class="btn btn-primary" id="btn_dar_salida">
        <i class="bi bi-box-arrow-up-right"></i> Dar Salida
      </button>
    </div>
  </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let tallasOrdenadas = [];
let colorActual = '';
let colorNombre = '';

const btnVerInventario = document.getElementById("btn_ver_inventario");

// Habilitar bot√≥n al seleccionar color
document.getElementById("color").addEventListener("change", (e) => {
  btnVerInventario.disabled = !e.target.value;
});

// Cargar inventario en el modal
btnVerInventario.addEventListener("click", async () => {
  const colorId = document.getElementById("color").value;
  if (!colorId) return;
  const modalBody = document.getElementById("modal_body_inventario");
  const totalDisponible = document.getElementById("modal_total_disponible");
  const totalSurtido = document.getElementById("modal_total_surtido");

  modalBody.innerHTML = "";
  totalDisponible.textContent = "0";
  totalSurtido.textContent = "0";

  const res = await fetch(`/inventario_por_color/${colorId}`);
  const data = await res.json();

  colorActual = data.color_id;
  colorNombre = data.color_nombre;
  tallasOrdenadas = data.tallas;

  document.getElementById("nombre_color_modal").textContent = colorNombre;

  let totalInv = 0;
  const table = document.createElement("table");
  table.className = "table table-bordered align-middle";
  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr class="table-light text-center">
      <th>Talla</th>
      <th>Disponible</th>
      <th>Surtir</th>
    </tr>`;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  data.tallas.forEach(t => {
    totalInv += t.cantidad;
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td class="fw-bold text-center">${t.nombre}</td>
      <td class="text-center">${t.cantidad}</td>
      <td><input type="number" class="form-control form-control-sm text-center surtido-input"
        name="surtido_${t.id}" min="0" max="${t.cantidad}" value="0"></td>`;
    if (t.cantidad === 0) {
      fila.classList.add("table-secondary");
      fila.querySelector("input").disabled = true;
    }
    tbody.appendChild(fila);
  });
  table.appendChild(tbody);
  modalBody.appendChild(table);
  totalDisponible.textContent = totalInv;

  modalBody.querySelectorAll(".surtido-input").forEach(input => {
    input.addEventListener("input", () => {
      let total = 0;
      modalBody.querySelectorAll(".surtido-input").forEach(i => {
        let val = parseInt(i.value) || 0;
        if (val < 0) val = 0;
        if (val > parseInt(i.max)) val = parseInt(i.max);
        i.value = val;
        total += val;
      });
      totalSurtido.textContent = total;
    });
  });
});

// Agregar al lote
document.getElementById("btn_agregar_modal").addEventListener("click", () => {
  const inputs = document.querySelectorAll(".surtido-input");
  let total = 0;
  const cantidadesPorTalla = {};

  // Recopilar cantidades
  tallasOrdenadas.forEach(t => {
    const val = parseInt(document.querySelector(`[name='surtido_${t.id}']`)?.value) || 0;
    total += val;
    cantidadesPorTalla[t.id] = val;
  });

  if (total === 0) {
    Swal.fire("Sin cantidades", "Debes surtir al menos una prenda.", "warning");
    return;
  }

  // Verificar que el color no est√© ya agregado
  if (document.querySelector(`#contenedor_vertical [data-color-id='${colorActual}']`)) {
    Swal.fire("Color duplicado", "Este color ya est√° en el lote.", "warning");
    return;
  }

  // Agregar resumen vertical
  agregarResumenVertical(colorActual, colorNombre, tallasOrdenadas, cantidadesPorTalla, total);

  // Deshabilitar color y limpiar
  document.querySelector(`#color option[value='${colorActual}']`).disabled = true;
  document.getElementById("color").value = "";
  document.getElementById("btn_ver_inventario").disabled = true;

  // Actualizar total general
  actualizarTotalGeneral();

  // Ocultar mensaje si no hay items
  ocultarMensajeSinItems();

  Swal.fire({
    icon: "success",
    title: "Color agregado al lote",
    timer: 1000,
    showConfirmButton: false
  });

  const modal = bootstrap.Modal.getInstance(document.getElementById("modalInventario"));
  modal.hide();
});

// ==============================
// RESUMEN DEL SURTIDO (VERTICAL)
// ==============================

function agregarResumenVertical(colorId, colorNombre, tallas, cantidadesPorTalla, totalColor) {
  const contenedor = document.getElementById("contenedor_vertical");

  // Crear card del color
  const card = document.createElement("div");
  card.className = "resumen-card";
  card.setAttribute("data-color-id", colorId);
  card.setAttribute("data-tallas", JSON.stringify(tallas));

  // Encabezado: color + bot√≥n eliminar
  const header = document.createElement("div");
  header.className = "resumen-card-header";
  header.innerHTML = `
    <span class="color-name">üé® ${colorNombre}</span>
    <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-vertical">
      <i class="bi bi-trash"></i> Eliminar
    </button>
  `;
  card.appendChild(header);

  // Tabla de tallas
  const tableWrapper = document.createElement("div");
  tableWrapper.className = "table-wrapper";
  
  const table = document.createElement("table");
  table.className = "table table-sm table-bordered resumen-table";
  
  const thead = document.createElement("thead");
  thead.className = "table-secondary sticky-top";
  thead.innerHTML = `
    <tr>
      <th class="text-center">üëï Talla</th>
      <th class="text-center">üì¶ Cantidad</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  let htmlBody = "";
  
  tallas.forEach(t => {
    const cantidad = cantidadesPorTalla[t.id] || 0;
    htmlBody += `
      <tr>
        <td class="text-center fw-bold">${t.nombre}</td>
        <td class="text-center" data-talla-id="${t.id}">${cantidad}</td>
      </tr>
    `;
  });

  // Total
  htmlBody += `
    <tr class="table-light fw-bold">
      <td class="text-center">Total Color:</td>
      <td class="text-center total-color">${totalColor}</td>
    </tr>
  `;

  tbody.innerHTML = htmlBody;
  table.appendChild(tbody);
  tableWrapper.appendChild(table);
  card.appendChild(tableWrapper);

  contenedor.appendChild(card);

  // Evento eliminar
  card.querySelector(".btn-eliminar-vertical").addEventListener("click", () => {
    eliminarResumenVertical(colorId);
  });
}

function eliminarResumenVertical(colorId) {
  const card = document.querySelector(`#contenedor_vertical [data-color-id='${colorId}']`);
  if (card) {
    card.remove();
    document.querySelector(`#color option[value='${colorId}']`).disabled = false;
    actualizarTotalGeneral();
    
    // Mostrar mensaje si no hay items
    if (document.querySelectorAll("#contenedor_vertical .resumen-card").length === 0) {
      document.getElementById("sin-items-msg").style.display = "block";
    }

    Swal.fire({
      icon: "info",
      title: "Color eliminado",
      timer: 800,
      showConfirmButton: false
    });
  }
}

function ocultarMensajeSinItems() {
  if (document.querySelectorAll("#contenedor_vertical .resumen-card").length > 0) {
    document.getElementById("sin-items-msg").style.display = "none";
  }
}

function actualizarTotalGeneral() {
  let total = 0;
  document.querySelectorAll("#contenedor_vertical .resumen-card").forEach(card => {
    const totalCell = card.querySelector(".total-color");
    if (totalCell) {
      total += parseInt(totalCell.textContent) || 0;
    }
  });
  document.getElementById("total_general").textContent = total;
}

// Enviar salida del lote
document.getElementById("btn_dar_salida").addEventListener("click", async () => {
  const cards = document.querySelectorAll("#contenedor_vertical .resumen-card");
  if (cards.length === 0) {
    Swal.fire("Sin datos", "No hay colores agregados al lote.", "warning");
    return;
  }

  const pedidoNumero = document.querySelector("[name='pedido']").value.trim();
  if (!pedidoNumero) {
    Swal.fire("Falta n√∫mero de pedido", "Debes ingresar un n√∫mero o c√≥digo de pedido.", "warning");
    return;
  }

  const confirmacion = await Swal.fire({
    title: "¬øDar salida al lote?",
    text: `Pedido: ${pedidoNumero}`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "S√≠, continuar",
    cancelButtonText: "Cancelar"
  });
  if (!confirmacion.isConfirmed) return;

  // Recopilar datos del lote desde las tarjetas verticales
  const datos = [];
  cards.forEach(card => {
    const colorId = parseInt(card.getAttribute("data-color-id"));
    const tallas = JSON.parse(card.getAttribute("data-tallas"));
    
    card.querySelectorAll("tbody tr:not(.table-light)").forEach((row, idx) => {
      const cantidad = parseInt(row.querySelector("td:last-child").textContent) || 0;
      if (cantidad > 0 && tallas[idx]) {
        datos.push({
          color_id: colorId,
          talla_id: tallas[idx].id,
          cantidad: cantidad
        });
      }
    });
  });

  const pedido = {
    pedido_numero: pedidoNumero,
    fecha: document.querySelector("[name='fecha']").value || "",
    tipo_salida: "Surtido",
    cliente: document.querySelector("[name='cliente']").value || "",
    usuario: "",
    observaciones: document.querySelector("[name='observaciones']")?.value || "",
    detalles: datos
  };

  const btn = document.getElementById("btn_dar_salida");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

  try {
    const res = await fetch("/salida_lote", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(pedido)
    });
    const result = await res.json();

    if (res.ok) {
      // Limpiar contenedor vertical
      document.getElementById("contenedor_vertical").innerHTML = "";
      document.getElementById("sin-items-msg").style.display = "block";

      // Habilitar todos los colores
      document.querySelectorAll("#color option").forEach(opt => opt.disabled = false);

      // Reset: datos del pedido
      document.querySelector("[name='cliente']").value = "";
      document.querySelector("[name='observaciones']").value = "";
      document.querySelector("[name='fecha']").value = "{{ fecha_hoy }}";
      document.getElementById("color").value = "";
      document.getElementById("btn_ver_inventario").disabled = true;

      // Reset totales
      actualizarTotalGeneral();

      // Obtener siguiente n√∫mero de pedido
      const respPedido = await fetch("/obtener_siguiente_pedido");
      const dataPedido = await respPedido.json();
      document.querySelector("[name='pedido']").value = dataPedido.siguiente_pedido;

      Swal.fire("√âxito", result.mensaje || "Lote registrado correctamente.", "success");

    } else {
      Swal.fire("Error", result.mensajes?.join("\n") || "Error desconocido.", "error");
    }
  } catch (err) {
    Swal.fire("Error", "Error de conexi√≥n con el servidor.", "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-box-arrow-up-right"></i> Dar Salida';
  }
});
</script>

{% endblock %}
